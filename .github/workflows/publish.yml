name: Publish Library

# Trigger automatically when the master branch receives code
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write # Required to push tags

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to check existing tags

      # 1. Read the VERSION file
      - name: Check Version
        id: check
        run: |
          VERSION=$(cat VERSION)
          TAG_NAME="v$VERSION"
          
          # Check if this tag already exists in Git
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists. Skipping release."
            echo "SHOULD_RELEASE=false" >> $GITHUB_OUTPUT
          else
            echo "New version detected ($VERSION). Proceeding."
            echo "SHOULD_RELEASE=true" >> $GITHUB_OUTPUT
            echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
            echo "VERSION=$VERSION" >> $GITHUB_ENV
          fi

      # 2. Defensive Testing (Only run if releasing)
      - name: Set up Python
        if: steps.check.outputs.SHOULD_RELEASE == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install & Verify
        if: steps.check.outputs.SHOULD_RELEASE == 'true'
        run: |
          pip install . 
          # You can run a quick import check here
          python -c "import novaeco_ui; print('NovaEco UI Import Successful')"

      # 3. Create Tag and Release
      - name: Create GitHub Release
        if: steps.check.outputs.SHOULD_RELEASE == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "NovaEco UI v${{ env.VERSION }}"
          generate_release_notes: true